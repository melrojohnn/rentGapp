name: Deploy to LocalStack

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to LocalStack
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.5.0"

    - name: Run tests
      run: mvn test

    - name: Build Docker image
      run: docker build -t rentapp:latest .

    - name: Start LocalStack
      run: |
        docker run -d \
          --name localstack \
          -p 4566:4566 \
          -e SERVICES=s3,dynamodb,rds,ecs,ecr,lambda,apigateway,cloudwatch \
          -e DEBUG=1 \
          -e AWS_DEFAULT_REGION=us-east-1 \
          localstack/localstack:latest

    - name: Wait for LocalStack
      run: |
        timeout 60 bash -c 'until curl -s http://localhost:4566 > /dev/null; do sleep 2; done'

    - name: Initialize Terraform
      run: |
        cd terraform
        export AWS_ACCESS_KEY_ID=test
        export AWS_SECRET_ACCESS_KEY=test
        export AWS_DEFAULT_REGION=us-east-1
        terraform init

    - name: Plan Terraform
      run: |
        cd terraform
        export AWS_ACCESS_KEY_ID=test
        export AWS_SECRET_ACCESS_KEY=test
        export AWS_DEFAULT_REGION=us-east-1
        terraform plan -out=tfplan

    - name: Apply Terraform
      run: |
        cd terraform
        export AWS_ACCESS_KEY_ID=test
        export AWS_SECRET_ACCESS_KEY=test
        export AWS_DEFAULT_REGION=us-east-1
        terraform apply tfplan

    - name: Deploy application
      run: |
        docker-compose up -d

    - name: Wait for application
      run: |
        timeout 120 bash -c 'until curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; do sleep 5; done'

    - name: Health check
      run: |
        curl -f http://localhost:8080/actuator/health
        echo "âœ… Application is healthy!"

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v3
      with:
        name: deployment-info
        path: |
          terraform/terraform.tfstate
          terraform/terraform.tfplan

    - name: Cleanup
      if: always()
      run: |
        docker-compose down
        docker stop localstack || true
        docker rm localstack || true
